---
categories: Webmaster
date: 2013/05/24 15:25:00
title: Ускоряем загрузку сайта с помощью простого и бесплатного CDN от Cloudflare
tags: минимализм, идиотизм, static blogging, webmaster, web, CDN, бесплатно, оптимизация
description: Еще один простой способ серьезно ускорить загрузку вашего сайта с помощью  и бесплатного CDN от Cloudflare
draft: false
permalink: http://thexnews.com/ускоряем-загрузку-сайта-cloudflare-cdn.html
---
<img class="alignleft size-thumbnail" width="150" height="150" alt="" src="/uploads/lightspeed.png" title="Ускорение загрузки сайта">

Итак вы [перевели блог в статику][st], [оптимизировали js, css и картинки][opt], [сделали кнопки социальных сетей асинхронными][ya]. И все равно вам кажеться что ваш сайт должен загружается быстрее. Что дальше? Следующим разумным шагом было бы:

* Установить на [каком-нибудь VPS] сверхбыстрый сервер [G-WAN] и раздавать статические html'ы оттуда.
* Или вообще отказаться от сервера, залить статические html'ы на [Amazon S3] и раздавать с помощью [Cloudfront].

Первый метод все равно не дает сильного прироста по сравнению с nginx (по моим тестам около 30%, потому что в независимости от того как быстро сервер отдает файл, основная задержка как правило в сети). Второй метод мне не подходит по заповеди - "Не храни все яйца в одной корзине, юный падаван". Ну не могу я хранить файлы у сервиса где я обычно покупаю кеды :).

Основной проблемой становиться ~~география~~ географическое положение. Я нахожусь в Европе, основная аудитория этого блога - в России. Поскольку хоститься в Европе дорого, а в России стрёмно, все сервера на которых работают мои сервисы находятся в Америке. Из за этих диких расстояний и теряются ценные секунды.

[img class="alignright" caption="Сайт с Cloudflare пингуеться в 10 раз быстрее" title=""]cloudflare-ping.png[/img] Обычно такие проблемы решаются с помощью CDN'ов ([Content Delivery Network]). В двух словах идея CDN: редко обновляемый контент сайта заливается на несколько серверов расположенных в разных частях мира. А когда посетитель запрашивает например картинку, она будет скачивается с ближайшего к нему сервера. 

Такие штуки как правило стоят денег, но есть классный бесплатный сервис [Cloudflare]. Сыр бесплатен в расчете на то, что когда вам понадобиться поддержка [SPDY, HTTPs, продвинутая защита от DDOS и.т.д] вы купите платный аккаунт. Но [скромному блогу][blog] то этого всего не надо, так что пока вам не потребуется [100 террабайт] траффика в месяц можно спокойно использовать эту CDN.

[img class="alignright" caption="Сайт с Cloudflare грузится в 6 раз быстрее" title=""]cloudflare-wget.png[/img]

Также Cloudflare спасает от простеньких DDOS. А если ваш основной сервер ляжет, то сайт все равно будет открываться из кэша Cloudflare. Ну и картинки с css и скриптами сжимать умеет. И траффик ваш по понятным причинам серьезно сэкономит. И даже всякую фигню типа [разнеси страницу][dest] навешивать умеет. Must have вообщем.

Итак, с помощью Cloudflare [на этом блоге][blog] который находиться на [Eskhosting'e][esk] удалось (см. скриншоты где-то рядом):

* Скорость загрузки увеличилась с 297 KB/s до 1.72 MB/s. 
* Время загрузки страницы сократиось в среднем с 2.91 сек до 1.09сек.
* Пинг с 161мс до 10мс.
* Вообщем загрузка сайта ускорилась примерно в 2-3 раза.

Теоретически Cloudflare может сделать быстрым и доступным для всего мира даже сайт на каком-нибудь копеечном шаред хостинге, где нибудь в Афганистане, Австралии или Замбезии с 50% uptime[^up]. Помоему преимущества очевидны. <!--more Далее пару советов по настройке -->

У Cloudflare очень дружественная к пользователю админка. Даже русский язык включить можно внизу страницы. Подключение сайта сделано максимально просто, по шагам его описывать я не вижу смысла. Cloudflare сам перетащит с себе существующие настройки DNS (например MX для почты) после чего вы можете смело направить свои DNS на их сервера. Потом надо подождать примерно сутки чтобы все обновилось. После этих простых действий, ваш сайт будет доступен напрямую по ip и по адресу `direct.вашсайт.сом` (используйте это чтобы подключиться по ftp например). Все остальные обращения к сайту будут идти через прокси Cloudflare, который будет отдавать контент с самого ближнего к посетителю сервера.

[img class="alignright" caption="Настройки Page Rules" title=""]cloudflare-page-rules.png[/img] По дефолту Cloudflare не кеширует html. Если у вас [статический сайт][st] (то есть все часто меняющиеся функции типа комментов и топов постов делаються JavaScriptом на клиентской стороне) то в настройках сайта создайте два правила (`Page Rules`) для страниц `вашсайт.com/*.html` и `вашсайт.com/` со значением `Custom caching` = `Cache everything` как показано на скриншоте справа. Если сайт не статический то вы все равно выиграете в скорости благодаря кешированию всего остального - картинок, стилей, скриптов etc.

Там же в настройках можно заказать оптимизацию для тех же скриптов и css'ов. Если вы не по каким то причинам не делаете это [сами][opt] позвольте Cloudflare сделать это за вас (`Performance settings` расставить птички для `JS`, `CSS`, `HTML` в `Auto Minify (Web optimization)`).

Все что нам остается сделать - после обновления вашего сайта послать Cloudflare [комманду] о том что нужно удалить все из кеша, чтобы изменения стали видны всем посетителям:

[code lang='bash']
curl https://www.cloudflare.com/api_json.html \
  -d 'a=fpurge_ts' \
  -d 'tkn=8afbe6dea02407989af4dd4c97bb6e25' \
  -d 'email=sample@example.com' \
  -d 'z=вашсайт.com' \
  -d 'v=1'
[/code]
Абракадабра `8afbe6dea02407989af4dd4c97bb6e25` - это у меня не клавиатура заела, а api key который бреться [здесь][apk].

Например я добавил это в скрипт [синхронизации новой версии сайта по ftp].

**UPD**: Минусом является то, что ваш сайт "лишается" своего уникального ip (если таковой был), и он будет находиться на одном ip с множеством других сайтов, которые так-же используют Cloudflare. А если какой-то иэ этих сайтов забанит ~~Росгосрыбнадзор~~ Роскосмоснадзор то и ваш сайт может попасть под одну гребёнку. Но как я понял теперь они аккуратнее работают, и такое реже происходит.

Спасибо за внимание. Всем желаю быстрого интернета! Godspeed, как говориться.

[blog]: http://thexnews.com/
[st]: http://thexnews.com/статический-блог-blogofile.html "Блог"
[opt]: http://thexnews.com/три-способа-ускорить-загрузку-вашего-сайта.html "Оптимизация сайта по скорости"
[сделали кнопки социальных сетей асинсхронными]: http://thexnews.com/кнопки-соцсетей-от-Яндекса.html "Быстрые кнопки социальных сетей"
[комманду]: https://www.cloudflare.com/docs/client-api.html#s4.4 "Cloudflare очистить кэщ"
[синхронизации новой версии сайта по ftp]: https://github.com/dmi3/thexnews.com/blob/master/blogofile/site_init/deploy_production.sh
[100 террабайт]: http://phoboslab.org/log/2013/02/how-much-traffic-is-too-much-traffic-for-cloudflare
[Cloudfront]: http://aws.amazon.com/cloudfront/
[Content Delivery Network]: http://ru.wikipedia.org/wiki/Content_Delivery_Network
[SPDY, HTTPs, продвинутая защита от DDOS и.т.д]: http://www.cloudflare.com/plans
[Cloudflare]: http://www.cloudflare.com/
[dest]: javascript:alert("Управление:\u0020кнопки\u0020←↑→↓\nСтрельба:\u0020[пробел]");var%20KICKASSVERSION='2.0';var%20s%20=%20document.createElement('script');s.type='text/javascript';document.body.appendChild(s);s.src='//hi.kickassapp.com/kickass.js';void(0);
[ya]: http://thexnews.com/кнопки-соцсетей-от-Яндекса.html
[каком-нибудь VPS]: https://www.digitalocean.com/?refcode=550d5b856a3c
[Amazon S3]: http://aws.amazon.com/s3/
[G-WAN]: http://gwan.com/
[apk]: https://www.cloudflare.com/my-account.html
[esk]: http://eskhosting.com/
[^up]: Потому что соляра в дизельгене постоянно кончается.